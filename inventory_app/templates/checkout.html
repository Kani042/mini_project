{% extends "base.html" %}
{% block content %}
  <!-- add shared stylesheet for consistent fonts/styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">

  <div class="container">
    <!-- header consistent with dashboard / inventory_new -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Checkout</h2>
     
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-danger">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <!-- Search Section -->
    <div class="section">
      <h2>1. Search & Add Products</h2>
      <div class="search-hint">Type 3+ characters to search products by name or ProductCode</div>
      <div class="search-wrapper">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search by ProductCode or product name..." autocomplete="off">
        </div>
        <ul id="search-results"></ul>
      </div>
    </div>
    
    <!-- Cart Section -->
    <div class="section">
      <h2>2. Your Cart</h2>
      {% if cart %}
        <div class="table-responsive force-scroll">
        <table class="cart-table table table-striped">
          <thead>
            <tr>
              <th>ProductCode</th>
              <th>Product</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="cart-body">
            {% for item in cart %}
              <tr data-item-id="{{ item.item_id }}">
                <td>{{ item.sku }}</td>
                <td>{{ item.name }}</td>
                <td class="text-end">${{ "%.2f"|format(item.unit_price) }}</td>
                <td class="text-end">{{ item.qty }}</td>
                <td class="text-end">${{ "%.2f"|format(item.unit_price * item.qty) }}</td>
                <td><button class="remove-btn" onclick="removeFromCart({{ item.item_id }})">Remove</button></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
        <div class="cart-summary">
          <div class="subtotal">Subtotal: ${{ "%.2f"|format(subtotal) }}</div>
        </div>
      {% else %}
        <div class="cart-empty">Cart is empty. Search and add products above.</div>
      {% endif %}
    </div>
    
    <!-- Customer Details Section -->
    {% if cart %}
      <div class="section">
        <h2>3. Customer Details & Finalize</h2>
        <form method="POST">
          <div class="form-row">
            <div class="form-group">
              <label for="mobile">Mobile Number *</label>
              <!-- mobile-friendly: type=tel, numeric keyboard, maxlength and autocomplete -->
              <input type="tel" id="mobile" name="mobile" required inputmode="numeric" pattern="[0-9]{8}" maxlength="8" autocomplete="tel" placeholder="8-digit mobile number">
            </div>
            <div class="form-group">
              <label for="name">Customer Name</label>
              <input type="text" id="name" name="name" placeholder="Optional">
            </div>
          </div>

          <!-- Payment Mode select (added) -->
          <div class="form-group">
            <label for="payment_mode">Payment Mode</label>
            <select id="payment_mode" name="payment_mode">
              <option value="Online">Online</option>
              <option value="Nets">Nets</option>
              <option value="Cash" selected>Cash</option>
              <option value="QR">QR</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tax_rate">Tax Rate (%)</label>
            <!-- numeric/decimal keyboard on mobile -->
            <input type="number" id="tax_rate" name="tax_rate" value="0" min="0" max="100" step="0.01" inputmode="decimal" pattern="[0-9]*([.,][0-9]+)?">
          </div>
          <button type="submit" class="submit-btn">Generate Invoice</button>
        </form>
      </div>
    {% endif %}
  </div>
  
  <script>
    let searchTimeout;
    
    function performSearch(query) {
      console.log('performSearch called with:', query);
      
      if (query.length < 3) {
        console.log('Query too short');
        document.getElementById('search-results').classList.remove('show');
        return;
      }
      
      const resultsList = document.getElementById('search-results');
      resultsList.innerHTML = '<li style="padding: 15px; text-align: center; color: #999;">Searching...</li>';
      resultsList.classList.add('show');
      
      const url = `/checkout/search?q=${encodeURIComponent(query)}`;
      console.log('Fetching from:', url);
      
      fetch(url)
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(items => {
          console.log('Items received:', items);
          const list = document.getElementById('search-results');
          list.innerHTML = '';
          
          if (!Array.isArray(items) || items.length === 0) {
            console.log('No items found');
            list.innerHTML = '<li style="padding: 15px; text-align: center; color: #999; cursor: default;">No products found</li>';
            list.classList.add('show');
            return;
          }
          
          console.log('Rendering', items.length, 'items');
          items.forEach(item => {
            const li = document.createElement('li');
            const isOutOfStock = item.stock <= 0;
            
            li.innerHTML = `
              <div class="item-info">
                <div class="item-name">${escapeHtml(item.name)}</div>
                <div class="item-sku">SKU: ${escapeHtml(item.sku)}</div>
                <div class="item-stock">Stock: ${item.stock} available</div>
              </div>
              <div class="item-actions">
                <div class="item-price">$${item.unit_price.toFixed(2)}</div>
                <input type="number" inputmode="numeric" pattern="[0-9]*" class="qty-input" value="1" min="1" max="${Math.max(1, item.stock)}" ${isOutOfStock ? 'disabled' : ''}>
                <button type="button" class="add-btn" onclick="addToCart(${item.id}, this)" ${isOutOfStock ? 'disabled' : ''}>
                  ${isOutOfStock ? 'Out of Stock' : 'Add'}
                </button>
              </div>
            `;
            list.appendChild(li);
          });
          list.classList.add('show');
        })
        .catch(error => {
          console.error('Search error:', error);
          const list = document.getElementById('search-results');
          list.innerHTML = '<li style="padding: 15px; text-align: center; color: red; cursor: default;">Error: ' + error.message + '</li>';
          list.classList.add('show');
        });
    }
    
    function addToCart(itemId, button) {
      const li = button.closest('li');
      const qtyInput = li.querySelector('.qty-input');
      const qty = parseInt(qtyInput.value);
      
      if (qty <= 0 || isNaN(qty)) {
        alert('Please enter a valid quantity');
        return;
      }
      
      button.disabled = true;
      button.textContent = 'Adding...';
      
      fetch('/checkout/add-to-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, qty: qty })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            alert(`âœ“ Added to cart! (${data.cart_count} item${data.cart_count > 1 ? 's' : ''})`);
            location.reload();
          } else {
            alert(data.error || 'Error adding to cart');
            button.disabled = false;
            button.textContent = 'Add';
          }
        })
        .catch(error => {
          console.error('Add to cart error:', error);
          alert('Error adding to cart');
          button.disabled = false;
          button.textContent = 'Add';
        });
    }
    
    function removeFromCart(itemId) {
      if (!confirm('Remove this item from cart?')) return;
      
      fetch('/checkout/remove-from-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error removing item');
          }
        })
        .catch(error => alert('Error removing item'));
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Real-time search as user types
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      if (query.length < 3) {
        document.getElementById('search-results').classList.remove('show');
        return;
      }
      searchTimeout = setTimeout(() => performSearch(query), 300);
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-wrapper') && !e.target.closest('.search-box')) {
        document.getElementById('search-results').classList.remove('show');
      }
    });
  </script>
{% endblock %}
