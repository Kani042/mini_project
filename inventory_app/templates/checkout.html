<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    .container { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    .back-link { display: inline-block; margin-bottom: 20px; padding: 8px 15px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; }
    .back-link:hover { background: #5a6268; }
    
    h1 { margin-bottom: 20px; color: #333; }
    
    .section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
    .section:last-child { border-bottom: none; }
    .section h2 { font-size: 18px; margin-bottom: 15px; color: #555; }
    
    .search-wrapper { position: relative; margin-bottom: 15px; }
    .search-box { display: flex; gap: 10px; }
    .search-box input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    
    .search-hint { font-size: 12px; color: #999; margin-bottom: 8px; }
    
    #search-results { 
      list-style: none; 
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 400px; 
      overflow-y: auto; 
      border: 1px solid #ddd; 
      border-radius: 4px;
      background: white;
      z-index: 1000;
      display: none;
      margin-top: 2px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    
    #search-results.show { display: block; }
    
    #search-results li { 
      padding: 12px 15px; 
      border-bottom: 1px solid #eee; 
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: background 0.2s;
    }
    #search-results li:hover { background: #f0f7ff; }
    #search-results li:last-child { border-bottom: none; }
    
    .item-info { flex: 1; }
    .item-name { font-weight: bold; color: #333; font-size: 14px; }
    .item-sku { font-size: 12px; color: #666; margin-top: 2px; }
    .item-stock { font-size: 12px; color: #999; margin-top: 2px; }
    
    .item-actions { display: flex; gap: 10px; align-items: center; }
    .item-price { font-weight: bold; color: #007bff; min-width: 80px; text-align: right; }
    .qty-input { width: 50px; padding: 5px; border: 1px solid #ddd; border-radius: 3px; text-align: center; }
    .add-btn { padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; white-space: nowrap; }
    .add-btn:hover { background: #218838; }
    .add-btn:disabled { background: #ccc; cursor: not-allowed; }
    
    .cart-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    .cart-table th { background: #f0f0f0; padding: 10px; text-align: left; font-weight: bold; border-bottom: 2px solid #ddd; }
    .cart-table td { padding: 10px; border-bottom: 1px solid #ddd; }
    .cart-table .remove-btn { padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; }
    .cart-table .remove-btn:hover { background: #c82333; }
    
    .cart-empty { text-align: center; padding: 20px; color: #999; }
    
    .totals { text-align: right; padding: 15px 0; font-size: 16px; }
    .totals div { margin-bottom: 10px; }
    .subtotal { color: #666; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    
    .submit-btn { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .submit-btn:hover { background: #0056b3; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    
    .alert { padding: 10px; margin-bottom: 15px; border-radius: 4px; }
    .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">← Back to Dashboard</a>
    <h1>Checkout</h1>
    
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-danger">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <!-- Search Section -->
    <div class="section">
      <h2>1. Search & Add Products</h2>
      <div class="search-hint">Type 3+ characters to search products by name or SKU</div>
      <div class="search-wrapper">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search by SKU or product name..." autocomplete="off">
        </div>
        <ul id="search-results"></ul>
      </div>
    </div>
    
    <!-- Cart Section -->
    <div class="section">
      <h2>2. Your Cart</h2>
      {% if cart %}
        <table class="cart-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Product</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="cart-body">
            {% for item in cart %}
              <tr data-item-id="{{ item.item_id }}">
                <td>{{ item.sku }}</td>
                <td>{{ item.name }}</td>
                <td>₹{{ "%.2f"|format(item.unit_price) }}</td>
                <td>{{ item.qty }}</td>
                <td>₹{{ "%.2f"|format(item.unit_price * item.qty) }}</td>
                <td><button class="remove-btn" onclick="removeFromCart({{ item.item_id }})">Remove</button></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="totals">
          <div class="subtotal">Subtotal: ₹{{ "%.2f"|format(subtotal) }}</div>
        </div>
      {% else %}
        <div class="cart-empty">Cart is empty. Search and add products above.</div>
      {% endif %}
    </div>
    
    <!-- Customer Details Section -->
    {% if cart %}
      <div class="section">
        <h2>3. Customer Details & Finalize</h2>
        <form method="POST">
          <div class="form-row">
            <div class="form-group">
              <label for="mobile">Mobile Number *</label>
              <input type="text" id="mobile" name="mobile" required pattern="[0-9]{10}" placeholder="10-digit mobile number">
            </div>
            <div class="form-group">
              <label for="name">Customer Name</label>
              <input type="text" id="name" name="name" placeholder="Optional">
            </div>
          </div>
          <div class="form-group">
            <label for="tax_rate">Tax Rate (%)</label>
            <input type="number" id="tax_rate" name="tax_rate" value="0" min="0" max="100" step="0.01">
          </div>
          <button type="submit" class="submit-btn">Generate Invoice</button>
        </form>
      </div>
    {% endif %}
  </div>
  
  <script>
    let searchTimeout;
    
    function performSearch(query) {
      console.log('performSearch called with:', query);
      
      if (query.length < 3) {
        console.log('Query too short');
        document.getElementById('search-results').classList.remove('show');
        return;
      }
      
      const resultsList = document.getElementById('search-results');
      resultsList.innerHTML = '<li style="padding: 15px; text-align: center; color: #999;">Searching...</li>';
      resultsList.classList.add('show');
      
      const url = `/checkout/search?q=${encodeURIComponent(query)}`;
      console.log('Fetching from:', url);
      
      fetch(url)
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(items => {
          console.log('Items received:', items);
          const list = document.getElementById('search-results');
          list.innerHTML = '';
          
          if (!Array.isArray(items) || items.length === 0) {
            console.log('No items found');
            list.innerHTML = '<li style="padding: 15px; text-align: center; color: #999; cursor: default;">No products found</li>';
            list.classList.add('show');
            return;
          }
          
          console.log('Rendering', items.length, 'items');
          items.forEach(item => {
            const li = document.createElement('li');
            const isOutOfStock = item.stock <= 0;
            
            li.innerHTML = `
              <div class="item-info">
                <div class="item-name">${escapeHtml(item.name)}</div>
                <div class="item-sku">SKU: ${escapeHtml(item.sku)}</div>
                <div class="item-stock">Stock: ${item.stock} available</div>
              </div>
              <div class="item-actions">
                <div class="item-price">₹${item.unit_price.toFixed(2)}</div>
                <input type="number" class="qty-input" value="1" min="1" max="${Math.max(1, item.stock)}" ${isOutOfStock ? 'disabled' : ''}>
                <button type="button" class="add-btn" onclick="addToCart(${item.id}, this)" ${isOutOfStock ? 'disabled' : ''}>
                  ${isOutOfStock ? 'Out of Stock' : 'Add'}
                </button>
              </div>
            `;
            list.appendChild(li);
          });
          list.classList.add('show');
        })
        .catch(error => {
          console.error('Search error:', error);
          const list = document.getElementById('search-results');
          list.innerHTML = '<li style="padding: 15px; text-align: center; color: red; cursor: default;">Error: ' + error.message + '</li>';
          list.classList.add('show');
        });
    }
    
    function addToCart(itemId, button) {
      const li = button.closest('li');
      const qtyInput = li.querySelector('.qty-input');
      const qty = parseInt(qtyInput.value);
      
      if (qty <= 0 || isNaN(qty)) {
        alert('Please enter a valid quantity');
        return;
      }
      
      button.disabled = true;
      button.textContent = 'Adding...';
      
      fetch('/checkout/add-to-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, qty: qty })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            alert(`✓ Added to cart! (${data.cart_count} item${data.cart_count > 1 ? 's' : ''})`);
            location.reload();
          } else {
            alert(data.error || 'Error adding to cart');
            button.disabled = false;
            button.textContent = 'Add';
          }
        })
        .catch(error => {
          console.error('Add to cart error:', error);
          alert('Error adding to cart');
          button.disabled = false;
          button.textContent = 'Add';
        });
    }
    
    function removeFromCart(itemId) {
      if (!confirm('Remove this item from cart?')) return;
      
      fetch('/checkout/remove-from-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error removing item');
          }
        })
        .catch(error => alert('Error removing item'));
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Real-time search as user types
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      console.log('Input event, query length:', query.length);
      
      if (query.length < 3) {
        document.getElementById('search-results').classList.remove('show');
        return;
      }
      
      searchTimeout = setTimeout(() => {
        performSearch(query);
      }, 300);
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-wrapper') && !e.target.closest('.search-box')) {
        document.getElementById('search-results').classList.remove('show');
      }
    });
  </script>
</body>
</html>
