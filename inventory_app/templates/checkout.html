{% extends "base.html" %}
{% block content %}
  <!-- add shared stylesheet for consistent fonts/styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">

  <div class="container">
    <!-- header consistent with dashboard / inventory_new -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Checkout</h2>
     
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-danger">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <!-- Search Section -->
    <div class="section">
      <h2>1. Search & Add Products</h2>
      <div class="search-hint">Type 3+ characters to search products by name or ProductCode</div>
      <div class="search-wrapper">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search by ProductCode or product name..." autocomplete="off">
        </div>
        <ul id="search-results"></ul>
      </div>
    </div>
    
    <!-- Cart Section -->
    <div class="section">
      <h2>2. Your Cart</h2>
      {% if cart %}
        <div class="table-responsive force-scroll">
        <table class="cart-table table table-striped">
          <thead>
            <tr>
              <th>ProductCode</th>
              <th>Product</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="cart-body">
            {% for item in cart %}
              <tr data-item-id="{{ item.item_id }}">
                <td>{{ item.sku }}</td>
                <td>{{ item.name }}</td>
                <td class="text-end">${{ "%.2f"|format(item.unit_price) }}</td>
                <td class="text-end">{{ item.qty }}</td>
                <td class="text-end">${{ "%.2f"|format(item.unit_price * item.qty) }}</td>
                <td><button class="remove-btn" onclick="removeFromCart({{ item.item_id }})">Remove</button></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
        <div class="cart-summary">
          <div class="subtotal">Subtotal: ${{ "%.2f"|format(subtotal) }}</div>
        </div>
      {% else %}
        <div class="cart-empty">Cart is empty. Search and add products above.</div>
      {% endif %}
    </div>
    
    <!-- Customer Details Section -->
    {% if cart %}
      <div class="section">
        <h2>3. Customer Details & Finalize</h2>
        <form method="POST" id="checkout-form">
          <div class="form-row">
            <div class="form-group" style="position:relative;">
              <label for="mobile">Mobile Number *</label>
              <!-- tel + inputmode + maxlength for mobile keyboards and client validation (8 digits) -->
              <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{8}" maxlength="8" inputmode="numeric" placeholder="8-digit mobile number" class="form-control">
            </div>
            <div class="form-group" style="position:relative;">
              <label for="name">Customer Name</label>
              <!-- autocomplete field: suggestions appear in #customer-suggestions; optional at checkout -->
              <input type="text" id="customer-name" name="name" placeholder="Type to search or enter new customer (optional)" autocomplete="off" class="form-control">
               <ul id="customer-suggestions" class="list-group" style="position:absolute; z-index:2000; width:100%; display:none; max-height:220px; overflow:auto;"></ul>
            </div>
          </div>

          <!-- Payment Mode select (added) -->
          <div class="form-group">
            <label for="payment_mode">Payment Mode</label>
            <select id="payment_mode" name="payment_mode">
              <option value="Online">Online</option>
              <option value="Nets">Nets</option>
              <option value="Cash" selected>Cash</option>
              <option value="QR">QR</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tax_rate">Tax Rate (%)</label>
            <!-- numeric/decimal keyboard on mobile -->
            <input type="number" id="tax_rate" name="tax_rate" value="0" min="0" max="100" step="0.01" inputmode="decimal" pattern="[0-9]*([.,][0-9]+)?">
          </div>
          <button type="submit" class="submit-btn">Generate Invoice</button>
        </form>
      </div>
    {% endif %}
  </div>

  <script>
  /* Consolidated checkout JS:
     - Product search: #search-input -> /checkout/search (min 3 chars, 300ms)
     - Customer autocomplete: #customer-name -> /customers/search (min 3 chars, 300ms)
     - Out-of-stock items show disabled "Out of Stock" and qty input disabled
     - addToCart/removeFromCart use same-origin fetch and reload on success
  */

  let searchTimeout;

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  /* PRODUCT SEARCH */
  function performSearch(query) {
    const resultsList = document.getElementById('search-results');
    if (!resultsList) return;

    if (!query || query.length < 3) {
      resultsList.classList.remove('show');
      resultsList.innerHTML = '';
      return;
    }

    resultsList.innerHTML = '<li style="padding:15px;text-align:center;color:#999;">Searching...</li>';
    resultsList.classList.add('show');

    fetch(`/checkout/search?q=${encodeURIComponent(query)}`, { credentials: 'same-origin' })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(items => {
        resultsList.innerHTML = '';
        if (!Array.isArray(items) || items.length === 0) {
          resultsList.innerHTML = '<li style="padding:15px;text-align:center;color:#999;">No products found</li>';
          resultsList.classList.add('show');
          return;
        }
        items.forEach(item => {
          const stockVal = (item.stock === undefined || item.stock === null) ? 0 : Number(item.stock);
          const isOut = stockVal <= 0;
          const li = document.createElement('li');
          li.className = 'd-flex justify-content-between align-items-center p-2';
          li.innerHTML = `
            <div style="flex:1;">
              <div class="item-name">${escapeHtml(item.name)}</div>
              <div class="item-sku text-muted small">SKU: ${escapeHtml(item.sku)}</div>
              <div class="item-stock text-muted small">${isOut ? '<strong style="color:#c00;">Out of Stock</strong>' : 'Stock: ' + escapeHtml(String(stockVal))}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-left:12px;">
              <div class="item-price"><strong>$${(item.unit_price||0).toFixed(2)}</strong></div>
              <input type="number" min="1" value="1" class="qty-input form-control form-control-sm" style="width:72px;margin-left:8px;" ${isOut ? 'disabled' : ''}>
              ${ isOut
                ? `<button type="button" class="btn btn-sm btn-secondary out-btn" disabled style="margin-left:6px;">Out of Stock</button>`
                : `<button type="button" class="btn btn-sm btn-primary add-btn" style="margin-left:6px;">Add</button>`
              }
            </div>
          `;
          if (!isOut) {
            const addBtn = li.querySelector('.add-btn');
            const qtyInput = li.querySelector('.qty-input');
            addBtn.addEventListener('click', () => {
              const qty = parseInt(qtyInput.value || "1", 10);
              if (isNaN(qty) || qty < 1) { alert('Enter valid quantity'); return; }
              addToCart(item.id, qty, addBtn);
            });
          }
          resultsList.appendChild(li);
        });
        resultsList.classList.add('show');
      })
      .catch(err => {
        console.error('Search error:', err);
        resultsList.innerHTML = '<li style="padding:15px;text-align:center;color:red;">Error</li>';
        resultsList.classList.add('show');
      });
  }

  function addToCart(itemId, qty, button) {
    if (qty <= 0) { alert('Enter valid quantity'); return; }
    button.disabled = true;
    const prevText = button.textContent;
    button.textContent = 'Adding...';
    fetch('/checkout/add-to-cart', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ item_id: itemId, qty: qty })
    })
    .then(r => r.json())
    .then(data => {
      if (data && data.success) location.reload();
      else {
        alert(data && data.error ? data.error : 'Error adding to cart');
        button.disabled = false;
        button.textContent = prevText;
      }
    })
    .catch(err => {
      console.error('Add to cart error:', err);
      alert('Error adding to cart');
      button.disabled = false;
      button.textContent = prevText;
    });
  }

  function removeFromCart(itemId) {
    if (!confirm('Remove this item from cart?')) return;
    fetch('/checkout/remove-from-cart', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ item_id: itemId })
    })
    .then(r => r.json())
    .then(data => {
      if (data && data.success) location.reload();
      else alert('Error removing item');
    })
    .catch(err => { console.error('Remove error', err); alert('Error removing item'); });
  }

  /* wire product search input */
  (function(){
    const prodInput = document.getElementById('search-input');
    if (!prodInput) return;
    prodInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const q = e.target.value.trim();
      if (q.length < 3) {
        const list = document.getElementById('search-results');
        if (list) { list.classList.remove('show'); list.innerHTML = ''; }
        return;
      }
      searchTimeout = setTimeout(() => performSearch(q), 300);
    });
  })();

  /* CUSTOMER AUTOCOMPLETE (mirrors product logic) */
  (function(){
    const input = document.getElementById('customer-name');
    const suggestions = document.getElementById('customer-suggestions');
    const mobileInput = document.getElementById('mobile');
    if (!input || !suggestions) return;
    let custTimer;
    input.addEventListener('input', (e) => {
      clearTimeout(custTimer);
      const q = e.target.value.trim();
      if (q.length < 3) { suggestions.style.display='none'; suggestions.innerHTML=''; return; }
      custTimer = setTimeout(() => {
        const url = `/customers/search?q=${encodeURIComponent(q)}`;
        fetch(url, { credentials: 'same-origin' })
          .then(resp => { if (!resp.ok) throw new Error('Network response not ok'); return resp.json(); })
          .then(items => {
            suggestions.innerHTML = '';
            if (!Array.isArray(items) || items.length === 0) { suggestions.style.display='none'; return; }
            items.forEach(c => {
              const li = document.createElement('li');
              li.className = 'list-group-item list-group-item-action';
              li.style.cursor = 'pointer';
              li.innerHTML = `<div><strong>${escapeHtml(c.name||'')}</strong></div><div class="text-muted small">${escapeHtml(c.mobile||'')}</div>`;
              li.addEventListener('click', () => {
                input.value = c.name || '';
                if (c.mobile && mobileInput) mobileInput.value = c.mobile;
                suggestions.style.display='none';
                suggestions.innerHTML='';
              });
              suggestions.appendChild(li);
            });
            suggestions.style.display = 'block';
          })
          .catch(err => {
            console.error('Customer search error:', err);
            suggestions.style.display='none';
            suggestions.innerHTML='';
          });
      }, 300);
    });
    document.addEventListener('click', (ev) => {
      if (!ev.target.closest('#customer-suggestions') && !ev.target.closest('#customer-name')) {
        if (suggestions) { suggestions.style.display='none'; suggestions.innerHTML=''; }
      }
    });
  })();

  /* close product dropdowns on outside click */
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-wrapper') && !e.target.closest('.search-box')) {
      const list = document.getElementById('search-results');
      if (list) list.classList.remove('show');
    }
  });
  </script>
{% endblock %}
